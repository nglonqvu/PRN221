@page
@model Web_PizzaShop.Pages.Admin.ProductEditModel
@{
    Layout = "_AdminLayout";
}
@Html.AntiForgeryToken()
<!DOCTYPE html>
<html lang="en">

<head>

    <!-- Demo CSS Files -->
    <link type="text/css" href="~/css/demo-files/ecommerce-product-edit.css" rel="stylesheet" />
    <link type="text/css" href="~/css/demo-files/form-file-upload.css" rel="stylesheet" />
</head>
<style>
    .size-item {
        cursor: pointer;
        font-size: 15px;
        transition: color 0.3s; /* Thêm hiệu ứng chuyển động */
    }

    .size-item:hover {
        color: red; /* Màu sẽ đổi khi hover vào */
    }

    .choosen {
        color: red;
    }
</style>
<body>
    <!-- START Body Container -->
    <div id="body-container">

        <!-- START Left Column -->
        <div id="left-column" class="">
            <!-- NOTE TO READER: Accepts the following class(es) "menu-icon-only", "fixed" class -->
            <div id="mainnav">
                <ul class="mainnav">
                    <!-- NOTE TO READER: Accepts the following class(es) "animate" class -->
                    <li class="menu-item-top">
                        <a href="index.html" class="top">
                            <span class="main-menu-icon">
                                <span aria-hidden="true" class="icon icon-grid-big"></span>
                            </span>
                            <span class="main-menu-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="menu-item-top selected">
                        <a href="#" class="top">
                            <span class="main-menu-icon">
                                <span aria-hidden="true" class="icon icon-dollar"></span>
                            </span>
                            <span class="main-menu-text">Dashboard</span>
                        </a>
                        <ul>
                            <li><a href="Dashboard">Dashboard</a></li>
                            <li><a href="OrderList">Order List</a></li>
                            <li><a href="ProductList">Product List</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <!-- END Left Column -->
        <!-- START Right Column -->
        <div id="right-column">
            <form method="post" class="form-horizontal product-edit" role="form">
                <input type="text" asp-for="@Model.pizza.Id" hidden>
                <div class="right-column-content container-fluid">
                    <div class="row">
                        <div class="col-xs-12">
                            <ol class="breadcrumb">
                                <li>
                                    <a href="ProductList">Pizza List</a>
                                </li>
                            </ol>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h1>
                                <span aria-hidden="true" class="icon icon-dollar"></span>
                                <span class="main-text">
                                    Product Edit
                                </span>
                            </h1>
                        </div>
                        <div class="col-md-6">

                            <!-- START Main Buttons -->
                            <div class="page-heading-controls">
                                <input class="btn btn-primary" role="button" type="submit" value="Save"
                                    id="saveButton" />
                                <a href="#" role="button" class="btn btn-info">Apply</a>
                                <a href="ecommerce-product-list.html" role="button" class="btn btn-danger">Cancel</a>
                            </div>
                            <!-- END Main Buttons -->

                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">

                            <!-- START Block: Product Edit -->
                            <div class="block">
                                <div class="block-content-outer">
                                    <div class="block-content-inner">

                                        <ul id="product-edit-tabs" class="nav nav-tabs tabs-alt-1">
                                            <li class="active">
                                                <a href="#product-edit-tabs-general" data-toggle="tab">General</a>
                                            </li>
                                            <li><a href="#product-edit-tabs-data" data-toggle="tab">Data</a></li>
                                            <li><a href="#product-edit-tabs-more" data-toggle="tab">More Sample Fields</a></li>
                                        </ul>
                                        <div class="tab-content">
                                            <div class="tab-pane active" id="product-edit-tabs-general">
                                                <div class="form-group">
                                                    <label for="product-location"
                                                        class="col-sm-2 col-md-2 control-label">
                                                        Image
                                                    </label>
                                                    <div class="col-sm-9">
                                                        <div class="row">
                                                            <div class="col-sm-3">
                                                                <div class="product-image-preview">
                                                                    <a href="#" data-toggle="modal"
                                                                        data-target="#product-image-preview-1">
                                                                        <img src="data:image/jpeg;base64,@Model.pizza.ImageUrl"
                                                                            width="200" height="130" alt="">
                                                                    </a>
                                                                    <p class="text-center">
                                                                        <a href="#" data-toggle="modal"
                                                                            data-target="#product-image-preview-1">
                                                                            Change
                                                                            Image
                                                                        </a>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="product-name" class="col-sm-2 col-md-2 control-label">
                                                        Pizza Name
                                                        <span class="required-item">*</span>
                                                    </label>
                                                    <div class="col-sm-4">
                                                        <input asp-for="@Model.pizza.Name" type="text"
                                                            class="form-control" id="product-name"
                                                            placeholder="Pizza Name">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="meta-desc" class="col-sm-2 col-md-2 control-label">
                                                        Description
                                                    </label>
                                                    <div class="col-sm-4">
                                                        <textarea asp-for="@Model.pizza.Description"
                                                            class="form-control" id="meta-desc" rows="4"
                                                            placeholder="This will be shows as your product description in search engines"></textarea>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="meta-keywords" class="col-sm-2 col-md-2 control-label">
                                                        Price
                                                    </label>
                                                    <div class="col-sm-4">
                                                        <input asp-for="@Model.pizza.Price" type="number"
                                                            class="form-control" id="product-name"
                                                            placeholder="Pizza Price">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="meta-keywords" class="col-sm-2 col-md-2 control-label">
                                                        Hot
                                                    </label>
                                                    <div class="col-sm-4">
                                                        <input class="form-check-input"
                                                            asp-for="@Model.pizza.IsPizzaOfTheWeek" type="checkbox">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-sm-2 col-md-2 control-label">Category</label>
                                                    <div class="col-sm-4">
                                                        <select class="form-control" name="CategoryId">
                                                            @{
                                                                foreach (var category in Model.categories)
                                                                {
                                                                    if (category.Id == Model.pizza.CategoriesId)
                                                                    {
                                                                        <option value="@category.Id" selected>
                                                                            @category.Name
                                                                        </option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="@category.Id">
                                                                            @category.Name
                                                                        </option>
                                                                    }
                                                                }
                                                            }
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="pizzaOfWeek"
                                                        class="col-sm-2 col-md-2 control-label">Create Date</label>
                                                    <div class="col-sm-4">
                                                        <input asp-for="@Model.pizza.CreatedAt" type="date"
                                                            class="form-control" readonly />
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="pizzaOfWeek"
                                                        class="col-sm-2 col-md-2 control-label">Delete Date</label>
                                                    <div class="col-sm-4">
                                                        <input asp-for="@Model.pizza.DeletedAt" type="date"
                                                            class="form-control" readonly />
                                                    </div>
                                                </div>

                                            </div>
                                            <form id="deleteForm" method="post">
                                                <div class="tab-pane" id="product-edit-tabs-data">
                                                    <div class="form-group">
                                                        <label for="selectedSize"
                                                            class="col-sm-2 col-md-2 control-label">Size</label>
                                                        <div style="display: flex;">
                                                                <div class="col-sm-4">
                                                                    <select id="selectedSize" name="selectedSize" class="form-control">
                                                                        @foreach (var size in Model.sizes)
                                                                        {
                                                                            <option value="@size.Id">@size.Size1</option>
                                                                        }
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <div class="col-sm-offset-2 col-sm-10">
                                                                        <button type="submit" asp-page-handler="AddSize" class="btn btn-primary"
                                                                            id="addSizeBtn">Add</button>
                                                                    </div>
                                                                </div>
                                                        </div>
                                                    </div>
                                                    <table class="table size_table">
                                                        <thead>
                                                            <tr>
                                                                <th class="text-center col-xs-1">Size</th>
                                                                <th class="text-center col-xs-1">Price</th>
                                                                <th class="text-center col-xs-1">Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var size in Model.pizza_sizes)
                                                            {
                                                                <tr>
                                                                    <input id="SizeIdDelete" name="SizeIdDelete" type="text" hidden>
                                                                    <td class="text-center col-xs-1" data-size-id="@size.Id">@size.Size1</td>
                                                                    <td class="text-center col-xs-1">@String.Format("{0:N0} đ", size.PriceSize)</td>
                                                                    <td class="text-center col-xs-1">
                                                                        <button type="submit" class="btn btn-danger delete-btn" asp-page-handler="DeleteSize">
                                                                            Delete
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </form>
                                                <div class="tab-pane" id="product-edit-tabs-more">
                                                    <div class="form-group">
                                                        <label for="selectedCake" class="col-sm-3 col-md-2 control-label">Cakebase</label>
                                                        <div style="display: flex;">
                                                            <div class="col-sm-4">
                                                                <select id="_selectedCake" name="_selectedCake" class="form-control">
                                                                    @foreach (var cake in Model.cakeBases)
                                                                    {
                                                                        <option value="@cake.Id">@cake.CakeBase</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <div class="col-sm-offset-2 col-sm-10">
                                                                    <button type="button" onclick="AddCakeBase('@Model.pizza.Id')" class="btn btn-primary" id="addSizeBtn">Insert</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                            <div style="display: flex;">
                                                <div class="left-column" style="width: 150px; float: left; padding-right: 20px;">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th class="text-center col-xs-1">Size</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var size in Model.pizza_sizes)
                                                            {
                                                            <tr>
                                                                <td class="size-item text-center col-xs-1" style="list-style: none; cursor: pointer; font-size: 15px;" data-size-id="@size.Id" onclick="selectSize('@size.Id', '@Model.pizza.Id')">@size.Size1</td>
                                                            </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="right-column" style="width: 1200px; float: right;">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th class="text-center col-xs-1">Cake Base</th>
                                                                <th class="text-center col-xs-1">Price</th>
                                                                <th class="text-center col-xs-1">Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- END Right Column -->

    </div>
    <!-- END Body Container -->
    <!-- START: Modal -->
        <div class="modal fade" id="product-image-preview-1" tabindex="-1" role="dialog"
        aria-labelledby="product-image-preview-label-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="product-image-preview-label-1">Upload A New Image</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <form method="post" enctype="multipart/form-data" asp-page-handler="UploadFile"
                                class="dropzone" id="customized-dropzone">
                                <input type="text" asp-for="@Model.pizza.Id" hidden>
                                <div class="dz-message">
                                    <span class="icon icon-download-selection icon-size-large"></span>
                                    <span class="main-text">Drop Your File Here</span>
                                </div>
                                <div class="fallback">
                                    <input name="file" type="file" />
                                </div>
                            </form>
                        </div>
                        <div class="col-sm-6">
                            <div id="customized-dropzone-results">
                                <h3>Upload Results</h3>
                                <p>The results of your uploads will be displayed here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="successModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="successModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                @if (@TempData["msg"] == "Your changes have been saved successfully." || @TempData["msg"] == "Add size successfully.")
                {
                    <div class="modal-body" style="color: green; text-align: center; font-size: large;">
                        @TempData["msg"]
                    </div>
                }
                else
                {
                    <div class="modal-body" style="color: red; text-align: center;">
                        @TempData["msg"]
                    </div>
                }
            </div>
        </div>
    </div>
    <div id="error_size" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="successModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">        
                <div class="modal-body" style="color: green; text-align: center; font-size: large;">
                    Please choose size before add cakebase
                </div>
            </div>
        </div>
    </div>
    @if (@TempData["msg"] != null)
    {
        <script>
            $(document).ready(function () {
                $('#successModal').modal('show');

                setTimeout(function () {
                    $('#successModal').modal('hide');
                }, 2500);
            });
        </script>
    }

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var deleteButtons = document.querySelectorAll('.delete-btn');

            deleteButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var sizeId = button.closest('tr').querySelector('[data-size-id]').getAttribute('data-size-id');
                    document.getElementById('SizeIdDelete').value = sizeId;
                });
            });
        });

        function selectSize(sizeId, _pizzaId) {
            $.ajax({
                type: 'POST',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN", $('input:hidden[name="__RequestVerificationToken"]').val());
                },
                url: '/Admin/ProductEdit?handler=CakeBaseByPizza_Size',
                data: {
                    sizeId: sizeId,
                    pizzaId: _pizzaId
                },
                success: function (response) {
                    $('.size-item').removeClass('choosen');
                    $(`.size-item[data-size-id="${sizeId}"]`).addClass('choosen');
                    var tableBody = $('.right-column tbody');
                    tableBody.empty();
                    response.$values.forEach(function (item) {
                        var newRow = `
                            <tr>
                                <td class="text-center col-xs-1" data-size-id="${item.$id}">${item.CakeBase}</td>
                                <td class="text-center col-xs-1">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.PriceBase)}</td>
                                <td class="text-center col-xs-1">
                                    <button type="button" class="btn btn-danger delete-btn" onclick="DeleteCakeBase('${item.PizzaOptions.$values[0].OptionId}','${@Model.pizza.Id}')">
                                        Delete
                                    </button>
                                </td>
                            </tr>`;
                        tableBody.append(newRow);
                    });
                },
                error: function (error) {
                    console.error(error);
                }
            });
        }

        function AddCakeBase(_pizzaId) {
            var selectedCake = document.getElementById("_selectedCake");
            var selectedValue = selectedCake.value;
            var selectedSizeId = getSelectedSizeId();
            if (selectedSizeId === null) {
                $('#error_size').modal('show');
                setTimeout(function () {
                    $('#error_size').modal('hide');
                }, 2500);
            }
            else{
                $.ajax({
                    type: 'POST',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN", $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                    url: '/Admin/ProductEdit?handler=AddCakeBase',
                    data: {
                        sizeId: selectedSizeId,
                        pizzaId: _pizzaId,
                        cakebaseId: selectedValue
                    },
                    success: function (response) {
                        var tableBody = $('.right-column tbody');
                        tableBody.empty();
                        response.$values.forEach(function (item) {
                            var newRow = `
                            <tr>
                                <td class="text-center col-xs-1" data-size-id="${item.$id}">${item.CakeBase}</td>
                                <td class="text-center col-xs-1">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.PriceBase)}</td>
                                <td class="text-center col-xs-1">
                                    <button type="button" class="btn btn-danger delete-btn" onclick="DeleteCakeBase('${item.PizzaOptions.$values[0].OptionId}','${@Model.pizza.Id}')">
                                        Delete
                                    </button>
                                </td>
                            </tr>`;
                            tableBody.append(newRow);
                        });
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            }
        }

        function DeleteCakeBase(optionId,_pizzaId) {
            var selectedSizeId = getSelectedSizeId();
            if (selectedSizeId === null) {
                $('#error_size').modal('show');
                setTimeout(function () {
                    $('#error_size').modal('hide');
                }, 2500);
            }
            else{
                $.ajax({
                    type: 'POST',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN", $('input:hidden[name="__RequestVerificationToken"]').val());
                    },
                    url: '/Admin/ProductEdit?handler=DeleteCakeBase',
                    data: {
                        sizeId: selectedSizeId,
                        pizzaId: _pizzaId,
                        optionId: optionId
                    },
                    success: function (response) {
                        var tableBody = $('.right-column tbody');
                        tableBody.empty();
                        response.$values.forEach(function (item) {
                            var newRow = `
                            <tr>
                                <td class="text-center col-xs-1" data-size-id="${item.$id}">${item.CakeBase}</td>
                                <td class="text-center col-xs-1">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.PriceBase)}</td>
                                <td class="text-center col-xs-1">
                                    <button type="button" class="btn btn-danger delete-btn" onclick="DeleteCakeBase('${item.PizzaOptions.$values[0].OptionId}','${@Model.pizza.Id}')">
                                        Delete
                                    </button>
                                </td>
                            </tr>`;
                            tableBody.append(newRow);
                        });
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            }
        }

        function getSelectedSizeId() {
            var selectedSizeElement = document.querySelector('.size-item.choosen');
            
            if (selectedSizeElement) {
                var sizeId = selectedSizeElement.getAttribute('data-size-id');
                return sizeId;
            }

            return null;
        }

</script>
    <!-- END: Modal -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- Required JS Files -->
    <script type="text/javascript" src="~/js/required/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="~/js/required/jquery-ui-1.11.0.custom/jquery-ui.min.js"></script>
    <script type="text/javascript" src="~/js/required/bootstrap/bootstrap.min.js"></script>
    <script type="text/javascript" src="~/js/required/jquery.easing.1.3-min.js"></script>
    <script type="text/javascript" src="~/js/required/jquery.mCustomScrollbar.min.js"></script>
    <script type="text/javascript" src="~/js/required/misc/jquery.mousewheel-3.0.6.min.js"></script>
    <script type="text/javascript" src="~/js/required/misc/retina.min.js"></script>
    <script type="text/javascript" src="~/js/required/icheck.min.js"></script>
    <script type="text/javascript" src="~/js/required/misc/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="~/js/required/circloid-functions.js"></script>

    <!-- Optional JS Files -->
    <script type="text/javascript" src="~/js/optional/misc/moment.js"></script>
    <script type="text/javascript" src="~/js/optional/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="~/js/optional/ckeditor/ckeditor.js"></script>
    <script type="text/javascript" src="~/js/optional/ckeditor/adapters/jquery.js"></script>
    <!-- This jQuery Adapter is REQUIRED for CKEditor to function properly -->
    <script type="text/javascript" src="~/js/optional/dropzone.min.js"></script>
    <!-- add optional JS plugin files here -->
    <!-- REQUIRED: User Editable JS Files -->
    <script type="text/javascript" src="~/js/script.js"></script>
    <!-- add additional User Editable files here -->
    <!-- Demo JS Files -->
    <script type="text/javascript" src="~/js/demo-files/ecommerce-product-edit.js"></script>
    <script type="text/javascript" src="~/js/demo-files/form-file-upload.js"></script>
</body>

</html>